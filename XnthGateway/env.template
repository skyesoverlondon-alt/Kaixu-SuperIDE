# Kaixu Gateway Site v5.x (Netlify DB + Gateway + KaixuPush) — Environment Variables Template
# Fill this out and paste into Netlify → Site configuration → Environment variables
# (or use as .env for `netlify dev`)
#
# NOTE: Netlify DB (Neon) injects NETLIFY_DATABASE_URL automatically when you attach a database.
#       You DO NOT set NETLIFY_DATABASE_URL manually in production.

# -----------------------------
# REQUIRED (minimum to operate)
# -----------------------------

# Admin dashboard password (used to obtain an admin JWT via /.netlify/functions/admin-login)
ADMIN_PASSWORD="CHANGE_ME_TO_A_STRONG_PASSWORD"

# JWT signing secret (LONG random string; used for admin JWTs and sessions)
JWT_SECRET="PASTE_A_LONG_RANDOM_SECRET_64+CHARS"

# CORS origin allowlist (STRICT-BY-DEFAULT build)
# - For first deploy/testing: "*"
# - For production: comma-separated exact origins, e.g.:
#     "https://your-gateway.netlify.app,https://solenterprises.org,http://localhost:8888"
ALLOWED_ORIGINS="*"

# Provider keys (set at least ONE provider you plan to allow)
OPENAI_API_KEY=""
ANTHROPIC_API_KEY=""
GEMINI_API_KEY=""

# -----------------------------
# RECOMMENDED SECURITY / ENTERPRISE CLEAN
# -----------------------------

# Encrypt sensitive DB fields (per-customer Netlify tokens, etc.)
# If unset, JWT_SECRET will be used as a fallback (works, but not ideal).
DB_ENCRYPTION_KEY="PASTE_A_DIFFERENT_LONG_RANDOM_SECRET_64+CHARS"

# Adds extra secret into API key hashing (defense-in-depth)
KEY_PEPPER="PASTE_A_LONG_RANDOM_SECRET_64+CHARS"

# Force JWT-only admin auth (recommended once you confirm admin login works)
DISABLE_ADMIN_PASSWORD_HEADER="true"

# Optional: Protect client error reporter endpoint (if unset, endpoint remains open)
CLIENT_ERROR_TOKEN=""

# Optional: Lock internal background worker kicks (recommended)
JOB_WORKER_SECRET="PASTE_A_LONG_RANDOM_SECRET_64+CHARS"

# -----------------------------
# KaixuPush Reliability / Rate Limits (recommended for production)
# -----------------------------
# Netlify deploy creation throttles (prevents hitting Netlify 429s)
PUSH_NETLIFY_MAX_DEPLOYS_PER_MIN="3"
PUSH_NETLIFY_MAX_DEPLOYS_PER_DAY="100"

# Chunk upload retry behavior (background workers)
PUSH_UPLOAD_INLINE_RETRIES="3"          # retries inside a single worker invocation
PUSH_JOB_MAX_ATTEMPTS="10"              # max worker invocations per file
PUSH_JOB_RETRY_BASE_MS="750"            # base backoff for transient failures
PUSH_JOB_RETRY_MAX_MS="30000"           # backoff cap

# -----------------------------
# DEFAULTS / GOVERNANCE (optional tuning)
# -----------------------------

# Default requests-per-minute per key (if not set per customer/key)
DEFAULT_RPM_LIMIT="120"

# Default monthly customer cap in cents (e.g. 2000 = $20.00)
DEFAULT_CUSTOMER_CAP_CENTS="2000"

# Send a warning when usage crosses this percent of cap (requires ALERT_WEBHOOK_URL)
CAP_WARN_PCT="85"
ALERT_WEBHOOK_URL=""

# User session TTL (seconds) for /session-token flows
USER_SESSION_TTL_SECONDS="21600"

# -----------------------------
# KAIXUPUSH (deploy operations)
# -----------------------------

# How long to keep unfinished chunk uploads before auto-cleanup (scheduled @daily)
PUSH_CHUNK_RETENTION_HOURS="48"

# Global Netlify PAT fallback (optional).
# Enterprise mode prefers per-customer tokens stored encrypted in DB via:
#   POST /.netlify/functions/admin-netlify-token { customer_id, token }
NETLIFY_AUTH_TOKEN=""

# -----------------------------
# RATE LIMITING AT SCALE (optional; DB fallback works)
# -----------------------------
UPSTASH_REDIS_REST_URL=""
UPSTASH_REDIS_REST_TOKEN=""

# -----------------------------
# STRIPE TOP-UPS (optional — only if you enable self-serve top-ups)
# -----------------------------
STRIPE_SECRET_KEY=""
STRIPE_WEBHOOK_SECRET=""
STRIPE_CURRENCY="usd"

# If PUBLIC_APP_ORIGIN is set, success/cancel URLs can be derived automatically:
PUBLIC_APP_ORIGIN=""

# Or set explicit URLs (recommended in production):
STRIPE_SUCCESS_URL=""
STRIPE_CANCEL_URL=""

# -----------------------------
# ASYNC JOB RETENTION (scheduled daily)
# -----------------------------
ASYNC_JOB_SUCCESS_RETENTION_DAYS="7"
ASYNC_JOB_RETENTION_DAYS="30"

# -----------------------------
# LOCAL DEV ONLY (do not set in Netlify when using Netlify DB)
# -----------------------------
# DATABASE_URL="postgres://user:pass@host:5432/dbname"

# ------------------------------
# GitHub Push Gateway (optional)
# ------------------------------
# Option A (recommended): GitHub OAuth App (web flow)
GITHUB_CLIENT_ID=""
GITHUB_CLIENT_SECRET=""
# The callback URL must match your OAuth app settings:
#   https://YOUR_SITE/.netlify/functions/github-oauth-callback
GITHUB_OAUTH_REDIRECT_URL=""

# Option B: Use a fine-grained PAT or classic PAT (store per customer via admin endpoint)
# No env var needed; token is stored encrypted in DB.
#
# Notes:
# - To push repo contents, token needs repo access (classic) or "Contents: write" (fine-grained).
# - To write .github/workflows, also require workflow scope/permission.

# GitHub API settings
GITHUB_API_BASE="https://api.github.com"
GITHUB_API_VERSION="2022-11-28"

# GitHub Push Job limits (safety)
GITHUB_PUSH_MAX_FILES="3000"
GITHUB_PUSH_MAX_TOTAL_BYTES="104857600"   # 100MB
GITHUB_PUSH_MAX_FILE_BYTES="10485760"     # 10MB

# GitHub Push retry engine
GITHUB_JOB_MAX_ATTEMPTS="10"
GITHUB_JOB_RETRY_BASE_MS="1000"
GITHUB_JOB_RETRY_MAX_MS="60000"

# GitHub ZIP chunk retention (scheduled gh-chunk-cleanup)
GITHUB_CHUNK_RETENTION_HOURS="48"
# -----------------------------
# VOICE (Twilio inbound assistant)
# -----------------------------
# Enable inbound call answering via Twilio webhooks:
#   /.netlify/functions/voice-twilio-inbound
#   /.netlify/functions/voice-twilio-turn
#   /.netlify/functions/voice-twilio-status

# Twilio credentials (required for signature validation)
TWILIO_ACCOUNT_SID="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
TWILIO_AUTH_TOKEN="your_twilio_auth_token"

# Optional: fallback transfer target (if a number has no playbook.transfer_number)
VOICE_FALLBACK_TRANSFER_NUMBER="+14804695416"

# Pricing knobs (USD per minute). Defaults are reasonable approximations.
VOICE_AI_RELAY_USD_PER_MIN="0.07"
VOICE_TELEPHONY_USD_PER_MIN="0.0085"
VOICE_RECORDING_USD_PER_MIN="0.0025"

# Markup used for customer billing rollups (default 31)
VOICE_MARKUP_PCT="31"

