<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>kAIxU Super IDE</title>
    <!--
      This HTML layout defines the shell for a browser‚Äëbased IDE.  It loads the
      Monaco editor, IndexedDB helper library, diff utilities and zip helpers
      from public CDNs.  The rest of the functionality lives in app.js.

      The page is split into a toolbar at the top, a side panel for the file
      tree and commit history, a main panel for the editor and search
      interface, and a preview pane which can be detached or maximised.
    -->
    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="styles.css" />
    <!-- External libraries were removed for offline support.  All functionality is implemented directly in app.js. -->
    <!-- The Monaco editor is not bundled to ensure offline functionality.  A simple
         textarea editor is used instead. -->
  </head>
  <body>
    <div id="app">
      <header id="toolbar">
        <!-- Brand/logo -->
        <div id="logo">
          <span class="logoText">kAIxU</span>
          <span class="logoSub">Super IDE</span>
        </div>
        <!-- File actions -->
        <button id="new-file">New File</button>
        <button id="save-file">Save File</button>
        <button id="delete-file">Delete</button>
        <button id="upload-files">Upload</button>
        <button id="upload-folder">Folder</button>
        <input type="file" id="file-upload" multiple style="display:none" />
        <input type="file" id="folder-upload" webkitdirectory directory multiple style="display:none" />
        <button id="export-zip">Export ZIP</button>
        <button id="sync-cloud" title="Sync workspace to Neon">Sync</button>
        <!-- Search / palette / split / format / settings -->
        <button id="search-panel-btn" title="Search workspace (Ctrl+Shift+F)">üîç</button>
        <button id="split-btn" title="Toggle split pane (Ctrl+\)">‚¨ú‚¨ú</button>
        <button id="cmd-palette-btn" title="Command palette (Ctrl+Shift+P)">‚åò</button>
        <button id="format-btn" title="Format document (Shift+Alt+F)">{ }</button>
        <button id="settings-btn" title="Settings">‚öô</button>
        <!-- Commits -->
        <input id="commit-message" placeholder="Commit message‚Ä¶" />
        <button id="commit-button">Commit</button>
        <button id="history-button">History</button>
        <button id="revert-button">Revert</button>
        <button id="export-patch-button">Export Patch</button>
        <!-- AI / safety -->
        <button id="ai-settings" title="AI + Agent settings">AI Settings</button>
        <label><input type="checkbox" id="diff-safety" checked />Diff Safety</label>
        <!-- Template selection -->
        <select id="template-select">
          <option value="">Template‚Ä¶</option>
        </select>
        <button id="apply-template">Apply</button>
        <button id="tutorial" title="Tutorial">Tutorial</button>
        <div class="userChip" id="userChip">Not signed in</div>
        <button id="authBtn">Sign in</button>
        <!-- Preview controls -->
        <button id="preview-toggle">Toggle Preview</button>
        <button id="preview-detach">Detach</button>
      </header>
      <main>
        <aside id="side">
          <div class="sideTabs">
            <button class="tabBtn active" data-tab="files">Files</button>
            <button class="tabBtn" data-tab="chat">Chat</button>
            <button class="tabBtn" data-tab="scm">Source</button>
          </div>

          <div id="files-pane" class="pane">
            <div class="orgBar">
              <select id="orgSelect" title="Organization"></select>
              <button id="newOrgBtn" title="Create org">+ Org</button>
              <select id="wsSelect" title="Workspace"></select>
              <button id="newWsBtn" title="Create workspace">+ WS</button>
            </div>

            <div id="file-tree"></div>
          </div>

          <div id="chat-pane" class="pane hidden">
            <div class="chatTop">
              <select id="chatScope" title="Agent scope">
                <option value="active">Active file</option>
                <option value="selected">Selected files</option>
                <option value="all" selected>Entire workspace</option>
              </select>
              <label title="Apply edits immediately"><input type="checkbox" id="autoApplyEdits" checked />Auto-apply</label>
              <label title="Commit after apply"><input type="checkbox" id="commitAfterApply" checked />Commit</label>
              <label title="Autosave while typing"><input type="checkbox" id="autoSave" checked />Autosave</label>
            </div>
            <div id="chatTimeline" class="chatTimeline"></div>
            <div class="chatComposer">
              <textarea id="chatInput" placeholder="Tell kAIxU what to change‚Ä¶" spellcheck="false"></textarea>
              <button id="chatSend">Send</button>
            </div>
          </div>

          <div id="history-pane" class="pane hidden"></div>
        </aside>
        <section id="editor-section">
          <!-- Search panel (hidden initially, toggled by Ctrl+Shift+F) -->
          <div id="search-panel" class="hidden">
            <div class="search-panel-header">
              <input id="sp-query" placeholder="Search‚Ä¶" />
              <input id="sp-replace" placeholder="Replace‚Ä¶" />
              <label><input type="checkbox" id="sp-regex" /> Regex</label>
              <label><input type="checkbox" id="sp-case" /> Case</label>
              <label><input type="checkbox" id="sp-word" /> Word</label>
              <button id="sp-search">Find</button>
              <button id="sp-replace-all">Replace All</button>
              <button id="sp-close">‚úï</button>
            </div>
            <div id="search-results"></div>
          </div>

          <!-- Dual editor panes -->
          <div id="editor-container">
            <!-- Pane 0 -->
            <div class="editor-pane" id="pane-0">
              <div class="tab-bar" id="tab-bar-0"></div>
              <div class="breadcrumb" id="breadcrumb-0"></div>
              <div class="file-viewer hidden" id="viewer-0"></div>
              <textarea class="editor-area" id="editor-0" spellcheck="false" placeholder="Open a file to start editing‚Ä¶"></textarea>
            </div>
            <!-- Split drag handle (hidden until split active) -->
            <div id="split-handle" class="hidden"></div>
            <!-- Pane 1 -->
            <div class="editor-pane hidden" id="pane-1">
              <div class="tab-bar" id="tab-bar-1"></div>
              <div class="breadcrumb" id="breadcrumb-1"></div>
              <div class="file-viewer hidden" id="viewer-1"></div>
              <textarea class="editor-area" id="editor-1" spellcheck="false" placeholder="Open a file in split pane‚Ä¶"></textarea>
            </div>
          </div>
        </section>
        <section id="preview-section" class="pane hidden">
          <iframe id="preview-frame" sandbox="allow-scripts allow-same-origin"></iframe>
        </section>
      </main>
    </div>

    <!-- Netlify Forms: hidden signup form so Netlify detects it -->
    <form name="signup" data-netlify="true" netlify-honeypot="bot-field" hidden>
      <input type="hidden" name="form-name" value="signup" />
      <input name="email" />
    </form>

    <!-- Toast notifications -->
    <div id="toast-container"></div>

    <!-- Right-click context menu -->
    <div id="ctx-menu" class="hidden"></div>

    <!-- Command Palette -->
    <div id="cmd-palette" class="dialog hidden">
      <div class="cmd-palette-box">
        <input id="cmd-input" placeholder="Type a command or file name‚Ä¶" autocomplete="off" spellcheck="false" />
        <div class="cmd-list" id="cmd-list"></div>
      </div>
    </div>

    <!-- Go-To-Line Modal -->
    <div id="goto-modal" class="dialog hidden">
      <div class="dialog-content" style="max-width:360px;">
        <h3>Go to Line</h3>
        <input id="goto-input" placeholder="Line number‚Ä¶" type="number" min="1" />
        <div class="dialog-buttons">
          <button id="goto-confirm">Go</button>
          <button id="goto-cancel">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="dialog hidden">
      <div class="dialog-content" style="max-width:520px;">
        <h3>Settings</h3>
        <div class="settings-section">
          <label>Font Size <input type="number" id="set-font-size" min="8" max="32" /> px</label>
          <label>Tab Size &nbsp;<input type="number" id="set-tab-size" min="1" max="8" /></label>
          <label><input type="checkbox" id="set-word-wrap" /> Word Wrap</label>
          <label>Auto Save
            <select id="set-auto-save">
              <option value="off">Off</option>
              <option value="idle">After Idle (1s)</option>
              <option value="keystroke">After Keystroke</option>
              <option value="blur">On Focus Loss</option>
            </select>
          </label>
          <label><input type="checkbox" id="set-format-save" /> Format on Save</label>
        </div>
        <h4>Keyboard Shortcuts</h4>
        <table class="shortcuts-table">
          <tr><td>Ctrl+S</td><td>Save</td></tr>
          <tr><td>Ctrl+Shift+S</td><td>Save All</td></tr>
          <tr><td>Ctrl+W</td><td>Close Tab</td></tr>
          <tr><td>Ctrl+\</td><td>Toggle Split</td></tr>
          <tr><td>Ctrl+1 / Ctrl+2</td><td>Focus Pane</td></tr>
          <tr><td>Ctrl+G</td><td>Go to Line</td></tr>
          <tr><td>Ctrl+Shift+P</td><td>Command Palette</td></tr>
          <tr><td>Ctrl+Shift+F</td><td>Search</td></tr>
          <tr><td>Ctrl+N</td><td>New File</td></tr>
          <tr><td>Ctrl+P</td><td>Toggle Preview</td></tr>
          <tr><td>Shift+Alt+F</td><td>Format Document</td></tr>
        </table>
        <div class="dialog-buttons" style="margin-top:16px;">
          <button id="settings-save">Save</button>
          <button id="settings-cancel">Close</button>
        </div>
      </div>
    </div>

    <!-- New File Dialog -->
    <div id="new-file-dialog" class="dialog hidden">
      <div class="dialog-content">
        <h3>Create New File</h3>
        <input id="new-file-path-input" placeholder="e.g. src/index.js" />
        <div class="dialog-buttons">
          <button id="new-file-confirm">Create</button>
          <button id="new-file-cancel">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="dialog hidden">
      <div class="dialog-content" style="max-width:520px;">
        <h3>kAIxU Super IDE ‚Äî Sign in</h3>
        <div class="authTabs">
          <button class="authTabBtn active" data-auth="login">Login</button>
          <button class="authTabBtn" data-auth="signup">Sign Up</button>
        </div>

        <div id="authLogin" class="authPanel">
          <input id="loginEmail" placeholder="Email" />
          <input id="loginPassword" placeholder="Password" type="password" />
          <div class="dialog-buttons">
            <button id="loginSubmit">Login</button>
            <button id="authClose">Close</button>
          </div>
        </div>

        <div id="authSignup" class="authPanel hidden">
          <input id="signupEmail" placeholder="Email" />
          <input id="signupPassword" placeholder="Password (8+ chars)" type="password" />
          <div class="muted" style="margin:8px 0;">Signup is captured as a Netlify Form + stored in Neon for authentication.</div>
          <div class="dialog-buttons">
            <button id="signupSubmit">Create account</button>
            <button id="authClose2">Close</button>
          </div>
        </div>

        <div class="muted" id="authStatus" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorialModal" class="dialog hidden">
      <div class="dialog-content" style="max-width:820px;">
        <h3>kAIxU Super IDE ‚Äî Tutorial</h3>
        <div class="tutorialBody">
          <ol>
            <li><b>Sign in</b> (top right). Your workspace can sync to Neon.</li>
            <li><b>Upload</b> files or a ZIP. The IDE imports everything into the workspace.</li>
            <li><b>Toggle Preview</b> to run your project. The preview updates live as you type (autosave).</li>
            <li><b>Commit</b> often. You can revert any time.</li>
            <li>Go to the <b>Chat</b> tab. Tell kAIxU what to change. It will propose edits and can auto-apply them.</li>
            <li><b>Undo</b> any AI message using the built-in checkpoint commit.</li>
          </ol>
          <div class="muted">Pro tip: Use Chat scope ‚ÄúSelected files‚Äù to keep edits precise.</div>
        </div>
        <div class="dialog-buttons">
          <button id="tutorialClose">Close</button>
        </div>
      </div>
    </div>
    <script src="jszip.min.js"></script>
    <script src="db.js"></script>
    <script src="ui.js"></script>
    <script src="editor.js"></script>
    <script src="explorer.js"></script>
    <script src="search.js"></script>
    <script src="commands.js"></script>
    <script src="app.js"></script>
  </body>
</html>