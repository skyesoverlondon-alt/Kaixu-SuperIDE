<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Snippet Hub ‚Äî kAIxU</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<style>
:root{--bg0:#040008;--bg1:#0d001a;--bg2:#16002e;--bg3:#1e003f;--purple:#a243ff;--purple-hot:#d130ff;--gold:#ffd36a;--cyan:#30e0ff;--green:#4fffb0;--red:#ff4f6a;--orange:#ff9f43;--fg:#e8e0f0;--fgd:#9988bb}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg0);color:var(--fg);font-family:'Inter',sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden}
header{background:var(--bg1);border-bottom:1px solid #2a0050;padding:10px 20px;display:flex;align-items:center;gap:16px;flex-shrink:0}
header h1{font-size:1.1rem;color:var(--purple-hot);font-family:'Share Tech Mono',monospace}
header span{color:var(--fgd);font-size:.8rem}
nav-pills{display:flex;gap:8px;margin-left:auto}
.pill{padding:5px 14px;border-radius:20px;border:1px solid #3a0066;background:var(--bg2);color:var(--fgd);font-size:.78rem;cursor:pointer;transition:.2s}
.pill:hover,.pill.active{background:var(--purple);color:#fff;border-color:var(--purple)}
main{display:flex;flex:1;overflow:hidden}
/* Sidebar */
.sidebar{width:260px;background:var(--bg1);border-right:1px solid #1a0030;display:flex;flex-direction:column;flex-shrink:0}
.sidebar-top{padding:12px;border-bottom:1px solid #1a0030}
.search-box{width:100%;background:var(--bg2);border:1px solid #3a0066;border-radius:6px;padding:8px 10px;color:var(--fg);font-size:.83rem;outline:none}
.search-box:focus{border-color:var(--purple)}
.sfilt{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.lang-badge{padding:2px 8px;border-radius:10px;border:1px solid #3a0066;background:var(--bg3);color:var(--fgd);font-size:.7rem;cursor:pointer;transition:.15s}
.lang-badge.active,.lang-badge:hover{border-color:var(--cyan);color:var(--cyan)}
.snip-list{flex:1;overflow-y:auto;padding:8px}
.snip-item{background:var(--bg2);border:1px solid #1a0030;border-radius:8px;padding:10px 12px;margin-bottom:8px;cursor:pointer;transition:.2s}
.snip-item:hover,.snip-item.active{border-color:var(--purple);background:var(--bg3)}
.snip-name{font-size:.85rem;font-weight:600;color:var(--fg)}
.snip-meta{font-size:.7rem;color:var(--fgd);margin-top:3px;display:flex;gap:8px;flex-wrap:wrap}
.snip-lang{color:var(--cyan)}
.snip-scope{color:var(--gold)}
.snip-uses{color:var(--green)}
.new-btn{margin:10px;padding:8px;border-radius:8px;background:var(--purple);border:none;color:#fff;font-size:.82rem;cursor:pointer;transition:.2s;font-weight:600}
.new-btn:hover{background:var(--purple-hot)}
/* Editor pane */
.editor-pane{flex:1;display:flex;flex-direction:column;overflow:hidden}
.ep-toolbar{background:var(--bg1);border-bottom:1px solid #1a0030;padding:10px 16px;display:flex;align-items:center;gap:10px;flex-shrink:0}
.ep-toolbar input{background:var(--bg2);border:1px solid #3a0066;border-radius:6px;padding:6px 10px;color:var(--fg);font-size:.85rem;outline:none;flex:1;min-width:0}
.ep-toolbar input:focus{border-color:var(--purple)}
.ep-toolbar select{background:var(--bg2);border:1px solid #3a0066;border-radius:6px;padding:6px 10px;color:var(--fg);font-size:.82rem;outline:none}
.btn{padding:6px 14px;border-radius:7px;border:none;font-size:.8rem;cursor:pointer;font-weight:600;transition:.2s}
.btn-purple{background:var(--purple);color:#fff}.btn-purple:hover{background:var(--purple-hot)}
.btn-green{background:var(--green);color:#040008}.btn-green:hover{opacity:.85}
.btn-cyan{background:var(--cyan);color:#040008}.btn-cyan:hover{opacity:.85}
.btn-gold{background:var(--gold);color:#040008}.btn-gold:hover{opacity:.85}
.btn-red{background:var(--red);color:#fff}.btn-red:hover{opacity:.85}
.btn-outline{background:transparent;color:var(--fgd);border:1px solid #3a0066}.btn-outline:hover{border-color:var(--purple);color:var(--purple)}
.code-area{flex:1;padding:16px;overflow:hidden;display:flex;flex-direction:column;gap:10px}
.code-editor{flex:1;background:var(--bg1);border:1px solid #2a0050;border-radius:8px;padding:12px;font-family:'Share Tech Mono',monospace;font-size:.82rem;color:var(--fg);resize:none;outline:none;min-height:0}
.code-editor:focus{border-color:var(--purple)}
.meta-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.meta-label{font-size:.75rem;color:var(--fgd)}
.tags-input{background:var(--bg2);border:1px solid #3a0066;border-radius:6px;padding:5px 8px;color:var(--fg);font-size:.78rem;outline:none;flex:1}
.tags-input:focus{border-color:var(--purple)}
/* Right panel */
.right-panel{width:300px;background:var(--bg1);border-left:1px solid #1a0030;display:flex;flex-direction:column;overflow:hidden}
.rp-tabs{display:flex;border-bottom:1px solid #1a0030}
.rp-tab{flex:1;padding:9px;text-align:center;font-size:.75rem;cursor:pointer;color:var(--fgd);transition:.2s;border-bottom:2px solid transparent}
.rp-tab.active{color:var(--purple);border-bottom-color:var(--purple)}
.rp-body{flex:1;overflow-y:auto;padding:12px}
.preview-box{background:var(--bg0);border:1px solid #1a0030;border-radius:8px;padding:12px;font-family:'Share Tech Mono',monospace;font-size:.78rem;color:var(--green);white-space:pre-wrap;word-break:break-all;min-height:120px}
.ai-result{background:var(--bg2);border:1px solid #3a0066;border-radius:8px;padding:10px;font-size:.8rem;color:var(--fg);line-height:1.6;margin-top:8px}
.stat-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #0f0020;font-size:.78rem}
.stat-row .val{color:var(--cyan);font-family:'Share Tech Mono',monospace}
.version-item{background:var(--bg2);border-radius:6px;padding:8px;margin-bottom:6px;font-size:.75rem}
.version-label{color:var(--gold);font-family:'Share Tech Mono',monospace}
/* Toast */
.toast{position:fixed;bottom:24px;right:24px;background:var(--bg2);border:1px solid var(--purple);border-radius:8px;padding:10px 18px;font-size:.82rem;z-index:9999;opacity:0;transition:.3s;pointer-events:none}
.toast.show{opacity:1}
/* Modal */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;display:flex;align-items:center;justify-content:center;display:none}
.modal-bg.open{display:flex}
.modal{background:var(--bg1);border:1px solid #3a0066;border-radius:12px;padding:24px;width:480px;max-width:95vw}
.modal h3{color:var(--gold);margin-bottom:14px}
.form-group{margin-bottom:12px}
.form-label{font-size:.75rem;color:var(--fgd);margin-bottom:4px;display:block}
.form-input{width:100%;background:var(--bg2);border:1px solid #3a0066;border-radius:6px;padding:8px;color:var(--fg);font-size:.83rem;outline:none}
.form-input:focus{border-color:var(--purple)}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
/* Empty state */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:12px;color:var(--fgd);font-size:.9rem}
.empty-icon{font-size:3rem}
</style>
<script src="../assets/kaixu-nav.js" defer></script>
</head>
<body>
<header>
  <h1>‚úÇÔ∏è Snippet Hub</h1>
  <span>Team-wide code snippet library powered by kAIxU</span>
  <div style="display:flex;gap:8px;margin-left:auto">
    <button class="pill active" onclick="filterScope('all')">All</button>
    <button class="pill" onclick="filterScope('workspace')">Workspace</button>
    <button class="pill" onclick="filterScope('personal')">Personal</button>
    <button class="pill" onclick="openImport()">‚Üë Import</button>
  </div>
</header>

<main>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-top">
      <input class="search-box" id="searchInput" placeholder="üîç Search snippets or ask kAIxU..." oninput="filterSnippets()"/>
      <div class="sfilt" id="langFilters"></div>
    </div>
    <div class="snip-list" id="snipList"></div>
    <button class="new-btn" onclick="newSnippet()">+ New Snippet</button>
  </div>

  <!-- Editor -->
  <div class="editor-pane">
    <div class="ep-toolbar">
      <input id="snipTitle" placeholder="Snippet name..." style="max-width:200px"/>
      <select id="snipLang">
        <option>javascript</option><option>typescript</option><option>python</option>
        <option>rust</option><option>go</option><option>css</option><option>html</option>
        <option>sql</option><option>bash</option><option>json</option><option>yaml</option>
        <option>markdown</option><option>other</option>
      </select>
      <select id="snipScope">
        <option value="workspace">Workspace</option>
        <option value="org">Org</option>
        <option value="personal">Personal</option>
      </select>
      <button class="btn btn-cyan" onclick="aiTag()">ü§ñ AI Tag</button>
      <button class="btn btn-green" onclick="saveSnippet()">üíæ Save</button>
      <button class="btn btn-purple" onclick="insertSnippet()">‚ö° Insert</button>
      <button class="btn btn-outline" onclick="downloadSnippet()" title="Download snippet as file">‚¨á Download</button>
      <button class="btn btn-red" onclick="deleteSnippet()">üóë</button>
    </div>
    <div class="code-area">
      <div class="meta-row">
        <span class="meta-label">Description:</span>
        <input id="snipDesc" class="tags-input" placeholder="What does this snippet do?" style="flex:2"/>
        <span class="meta-label">Tags:</span>
        <input id="snipTags" class="tags-input" placeholder="auth, api, hooks..."/>
      </div>
      <div id="editorEmpty" class="empty" style="flex:1">
        <div class="empty-icon">‚úÇÔ∏è</div>
        <div>Select a snippet or create a new one</div>
        <button class="btn btn-purple" onclick="newSnippet()">+ New Snippet</button>
      </div>
      <textarea class="code-editor" id="codeEditor" placeholder="// Write your snippet here&#10;// Use ${1:placeholder} for tabstops" style="display:none"></textarea>
    </div>
  </div>

  <!-- Right Panel -->
  <div class="right-panel">
    <div class="rp-tabs">
      <div class="rp-tab active" onclick="rpTab('preview',this)">Preview</div>
      <div class="rp-tab" onclick="rpTab('stats',this)">Stats</div>
      <div class="rp-tab" onclick="rpTab('history',this)">History</div>
    </div>
    <div class="rp-body" id="rpBody">
      <div class="preview-box" id="previewBox">Select a snippet to preview...</div>
      <div class="ai-result" id="aiResult" style="display:none"></div>
      <button class="btn btn-outline" onclick="aiExplain()" style="width:100%;margin-top:10px;font-size:.75rem">ü§ñ Ask kAIxU to explain this snippet</button>
    </div>
  </div>
</main>

<!-- Import Modal -->
<div class="modal-bg" id="importModal">
  <div class="modal">
    <h3>Import Snippets</h3>
    <div class="form-group">
      <label class="form-label">Paste VS Code snippets.json</label>
      <textarea class="form-input" id="importJson" rows="8" placeholder='{"Print to console":{"prefix":"log","body":["console.log($1);"],"description":"Log"}}'></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Target scope</label>
      <select class="form-input" id="importScope">
        <option value="workspace">Workspace</option>
        <option value="personal">Personal</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeImport()">Cancel</button>
      <button class="btn btn-purple" onclick="doImport()">Import</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const WORKER=(window.KAIXU_WORKER||'https://kaixusi'+'.skyesoverlondon.workers.dev');
function getToken(){try{return JSON.parse(localStorage.getItem('sovereign_brain_cfg')||'{}').token||'';}catch(e){return '';}}
function toast(m,c='var(--purple)'){const t=document.getElementById('toast');t.textContent=m;t.style.borderColor=c;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800)}

// ‚îÄ‚îÄ Snippet store ‚îÄ‚îÄ
const LS_KEY='kaixu_snippets_v1';
let snippets=[];
let current=null;
let currentScope='all';
let currentLang='all';

function loadSnippets(){
  try{snippets=JSON.parse(localStorage.getItem(LS_KEY)||'[]');}catch(e){snippets=[];}
  if(!snippets.length) loadDefaults();
}
function saveToStorage(){localStorage.setItem(LS_KEY,JSON.stringify(snippets));}
function loadDefaults(){
  snippets=[
    {id:uid(),name:'Console log',lang:'javascript',scope:'workspace',desc:'Log value to console',tags:['debug','log'],body:'console.log(${1:value});',uses:12,versions:[],created:Date.now()},
    {id:uid(),name:'Async fetch wrapper',lang:'javascript',scope:'workspace',desc:'Fetch with error handling',tags:['api','async'],body:'async function fetchData(url) {\n  try {\n    const res = await fetch(url);\n    if (!res.ok) throw new Error(`HTTP ${res.status}`);\n    return await res.json();\n  } catch (err) {\n    console.error(err);\n    throw err;\n  }\n}',uses:8,versions:[],created:Date.now()-86400000},
    {id:uid(),name:'Python dataclass',lang:'python',scope:'workspace',desc:'Minimal dataclass template',tags:['class','typing'],body:'from dataclasses import dataclass\n\n@dataclass\nclass ${1:MyModel}:\n    ${2:field}: ${3:str}\n\n    def __repr__(self):\n        return f"${1:MyModel}(${2:field}={self.${2:field}!r})"',uses:5,versions:[],created:Date.now()-172800000},
    {id:uid(),name:'SQL upsert',lang:'sql',scope:'workspace',desc:'Insert or update on conflict',tags:['db','upsert'],body:'INSERT INTO ${1:table} (${2:col1}, ${3:col2})\nVALUES ($4, $5)\nON CONFLICT (${2:col1}) DO UPDATE\n  SET ${3:col2} = EXCLUDED.${3:col2};',uses:3,versions:[],created:Date.now()-259200000},
  ];
  saveToStorage();
}

function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7);}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function renderLangFilters(){
  const langs=['all',...new Set(snippets.map(s=>s.lang))];
  const el=document.getElementById('langFilters');
  el.innerHTML=langs.map(l=>`<span class="lang-badge${l===currentLang?' active':''}" onclick="setLang('${l}')">${l}</span>`).join('');
}
function setLang(l){currentLang=l;renderLangFilters();renderList();}
function filterScope(s){currentScope=s;document.querySelectorAll('nav-pills .pill, header .pill').forEach(p=>{p.classList.remove('active');});event&&event.target.classList.add('active');renderList();}
function filterSnippets(){renderList();}

function renderList(){
  const q=document.getElementById('searchInput').value.toLowerCase();
  const el=document.getElementById('snipList');
  const filtered=snippets.filter(s=>{
    if(currentScope!=='all'&&s.scope!==currentScope) return false;
    if(currentLang!=='all'&&s.lang!==currentLang) return false;
    if(q&&!s.name.toLowerCase().includes(q)&&!s.tags.join(' ').includes(q)&&!s.desc.toLowerCase().includes(q)) return false;
    return true;
  }).sort((a,b)=>b.uses-a.uses);
  if(!filtered.length){el.innerHTML='<div style="padding:20px;text-align:center;color:var(--fgd);font-size:.8rem">No snippets found</div>';return;}
  el.innerHTML=filtered.map(s=>`
    <div class="snip-item${current&&current.id===s.id?' active':''}" onclick="selectSnippet('${s.id}')">
      <div class="snip-name">${s.name}</div>
      <div class="snip-meta">
        <span class="snip-lang">${s.lang}</span>
        <span class="snip-scope">${s.scope}</span>
        <span class="snip-uses">‚Üë${s.uses}</span>
        ${s.tags.slice(0,2).map(t=>`<span style="color:var(--fgd)">#${t}</span>`).join('')}
      </div>
    </div>`).join('');
}

function selectSnippet(id){
  current=snippets.find(s=>s.id===id)||null;
  if(!current) return;
  document.getElementById('snipTitle').value=current.name;
  document.getElementById('snipLang').value=current.lang;
  document.getElementById('snipScope').value=current.scope;
  document.getElementById('snipDesc').value=current.desc;
  document.getElementById('snipTags').value=current.tags.join(', ');
  document.getElementById('codeEditor').value=current.body;
  document.getElementById('codeEditor').style.display='block';
  document.getElementById('editorEmpty').style.display='none';
  updatePreview();
  renderList();
}

function updatePreview(){
  if(!current){return;}
  document.getElementById('previewBox').textContent=current.body||'(empty)';
}

document.getElementById('codeEditor').addEventListener('input',()=>{
  if(current) document.getElementById('previewBox').textContent=document.getElementById('codeEditor').value;
});

function newSnippet(){
  const s={id:uid(),name:'New Snippet',lang:'javascript',scope:'workspace',desc:'',tags:[],body:'',uses:0,versions:[],created:Date.now()};
  snippets.unshift(s);
  saveToStorage();
  renderLangFilters();
  renderList();
  selectSnippet(s.id);
}

function saveSnippet(){
  if(!current){toast('Select or create a snippet first','var(--red)');return;}
  const old=current.body;
  current.name=document.getElementById('snipTitle').value||'Untitled';
  current.lang=document.getElementById('snipLang').value;
  current.scope=document.getElementById('snipScope').value;
  current.desc=document.getElementById('snipDesc').value;
  current.tags=document.getElementById('snipTags').value.split(',').map(t=>t.trim()).filter(Boolean);
  current.body=document.getElementById('codeEditor').value;
  if(old&&old!==current.body) current.versions.push({body:old,ts:Date.now()});
  saveToStorage();
  renderLangFilters();
  renderList();
  toast('Snippet saved ‚úì','var(--green)');
}

function deleteSnippet(){
  if(!current){return;}
  snippets=snippets.filter(s=>s.id!==current.id);
  current=null;
  document.getElementById('codeEditor').style.display='none';
  document.getElementById('editorEmpty').style.display='flex';
  saveToStorage();
  renderLangFilters();
  renderList();
  toast('Deleted','var(--red)');
}

function insertSnippet(){
  if(!current){toast('No snippet selected','var(--red)');return;}
  current.uses++;
  saveToStorage();
  navigator.clipboard.writeText(current.body).then(()=>{
    toast('Snippet copied to clipboard ‚ö°','var(--cyan)');
    renderList();
  });
}
const _LANG_EXT={javascript:'js',typescript:'ts',python:'py',rust:'rs',go:'go',css:'css',html:'html',sql:'sql',bash:'sh',json:'json',yaml:'yaml',markdown:'md'};
function downloadSnippet(){
  if(!current||!current.body){toast('No snippet to download','var(--orange)');return;}
  const ext=_LANG_EXT[current.lang]||'txt';
  const name=(current.name||'snippet').replace(/[^a-z0-9_-]/gi,'_');
  const blob=new Blob([current.body],{type:'text/plain'});
  const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:`${name}.${ext}`});
  a.click(); URL.revokeObjectURL(a.href);
  toast(`Downloaded ${name}.${ext} ‚úì`,'var(--green)');
}

// ‚îÄ‚îÄ AI features ‚îÄ‚îÄ
async function aiTag(){
  if(!current||!document.getElementById('codeEditor').value){toast('Add code first','var(--orange)');return;}
  toast('kAIxU is tagging...','var(--purple)');
  const code=document.getElementById('codeEditor').value;
  try{
    const r=await fetch(`${WORKER}/v1/chat`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${getToken()}`},
      body:JSON.stringify({messages:[
        {role:'user',content:`Analyze this code snippet and return ONLY a JSON object with: {"name":"short name","desc":"one line description","tags":["tag1","tag2","tag3"],"lang":"language"}. Code:\n\`\`\`\n${code}\n\`\`\``}
      ],max_tokens:200,app_id:'kaixu-snippethub'})});
    const d=await r.json();
    const txt=(d.choices?.[0]?.message?.content||d.content||'').replace(/```json?/g,'').replace(/```/g,'').trim();
    const parsed=JSON.parse(txt);
    if(parsed.name) document.getElementById('snipTitle').value=parsed.name;
    if(parsed.desc) document.getElementById('snipDesc').value=parsed.desc;
    if(parsed.tags) document.getElementById('snipTags').value=parsed.tags.join(', ');
    if(parsed.lang) document.getElementById('snipLang').value=parsed.lang;
    toast('AI tagged! ‚úì','var(--green)');
  }catch(e){toast('AI tag failed','var(--red)');}
}

async function aiExplain(){
  if(!current){toast('Select a snippet first','var(--orange)');return;}
  const box=document.getElementById('aiResult');
  box.style.display='block';
  box.textContent='kAIxU is analyzing...';
  try{
    const r=await fetch(`${WORKER}/v1/chat`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${getToken()}`},
      body:JSON.stringify({messages:[
        {role:'user',content:`Explain this code snippet in plain English. Describe what it does, common use cases, and any gotchas:\n\`\`\`${current.lang}\n${current.body}\n\`\`\``}
      ],max_tokens:300,app_id:'kaixu-snippethub'})});
    const d=await r.json();
    const explanation=d.choices?.[0]?.message?.content||d.content||'No response';
    box.innerHTML=`<div id="aiResultText" style="white-space:pre-wrap">${explanation.replace(/</g,'&lt;')}</div>
      <div style="display:flex;gap:.5rem;margin-top:10px">
        <button class="btn btn-outline" onclick="navigator.clipboard.writeText(document.getElementById('aiResultText').textContent).then(()=>toast('Copied ‚úì','var(--green)'))" style="font-size:.72rem;flex:1">üìã Copy</button>
        <button class="btn btn-outline" onclick="(function(){const t=document.getElementById('aiResultText').textContent;const b=new Blob([t],{type:'text/plain'});const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(b),download:'kaixu-explanation.txt'});a.click();URL.revokeObjectURL(a.href);toast('Downloaded ‚úì','var(--green)');})()" style="font-size:.72rem;flex:1">‚¨á Download</button>
      </div>`;
  }catch(e){box.textContent='Error: '+e.message;}
}

// ‚îÄ‚îÄ Right panel tabs ‚îÄ‚îÄ
function rpTab(tab, el){
  document.querySelectorAll('.rp-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  const body=document.getElementById('rpBody');
  if(tab==='preview'){
    body.innerHTML=`<div class="preview-box" id="previewBox">${current?current.body:'Select a snippet to preview...'}</div>
    <div class="ai-result" id="aiResult" style="display:none"></div>
    <button class="btn btn-outline" onclick="aiExplain()" style="width:100%;margin-top:10px;font-size:.75rem">ü§ñ Ask kAIxU to explain this snippet</button>`;
  }else if(tab==='stats'){
    body.innerHTML=current?`
    <div class="stat-row"><span>Uses</span><span class="val">${current.uses}</span></div>
    <div class="stat-row"><span>Language</span><span class="val">${current.lang}</span></div>
    <div class="stat-row"><span>Scope</span><span class="val">${current.scope}</span></div>
    <div class="stat-row"><span>Versions saved</span><span class="val">${current.versions.length}</span></div>
    <div class="stat-row"><span>Created</span><span class="val">${new Date(current.created).toLocaleDateString()}</span></div>
    <div class="stat-row"><span>Tags</span><span class="val">${current.tags.join(', ')||'none'}</span></div>
    `:'<div style="color:var(--fgd);padding:20px;text-align:center">Select a snippet</div>';
  }else if(tab==='history'){
    body.innerHTML=current&&current.versions.length?current.versions.slice().reverse().map((v,i)=>`
    <div class="version-item"><div class="version-label">v${current.versions.length-i} ¬∑ ${new Date(v.ts).toLocaleString()}</div>
    <pre style="font-size:.7rem;color:var(--fgd);margin-top:4px;white-space:pre-wrap;overflow:auto;max-height:100px">${v.body.slice(0,200)}</pre>
    <button class="btn btn-outline" style="font-size:.7rem;margin-top:6px" onclick="restoreVersion(${current.versions.length-1-i})">Restore</button></div>`).join(''):'<div style="color:var(--fgd);padding:20px;text-align:center">No version history yet</div>';
  }
}

function restoreVersion(idx){
  if(!current){return;}
  const v=current.versions[idx];
  document.getElementById('codeEditor').value=v.body;
  toast('Version restored','var(--gold)');
}

// ‚îÄ‚îÄ Import ‚îÄ‚îÄ
function openImport(){document.getElementById('importModal').classList.add('open');}
function closeImport(){document.getElementById('importModal').classList.remove('open');}
function doImport(){
  try{
    const raw=JSON.parse(document.getElementById('importJson').value);
    const scope=document.getElementById('importScope').value;
    let count=0;
    for(const[name,def]of Object.entries(raw)){
      const body=Array.isArray(def.body)?def.body.join('\n'):def.body||'';
      snippets.push({id:uid(),name,lang:'other',scope,desc:def.description||'',tags:[],body,uses:0,versions:[],created:Date.now()});
      count++;
    }
    saveToStorage();
    renderLangFilters();
    renderList();
    closeImport();
    toast(`Imported ${count} snippet${count!==1?'s':''} ‚úì`,'var(--green)');
  }catch(e){toast('Invalid JSON ‚Äî check format','var(--red)');}
}

// ‚îÄ‚îÄ Natural language AI search ‚îÄ‚îÄ
let nlTimer=null;
document.getElementById('searchInput').addEventListener('input',function(){
  const q=this.value;
  clearTimeout(nlTimer);
  filterSnippets();
  if(q.length>20){
    nlTimer=setTimeout(()=>nlSearch(q),800);
  }
});

async function nlSearch(q){
  toast('kAIxU searching...','var(--purple)');
  try{
    const r=await fetch(`${WORKER}/v1/chat`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${getToken()}`},
      body:JSON.stringify({messages:[
        {role:'user',content:`I have these snippets: ${JSON.stringify(snippets.map(s=>({id:s.id,name:s.name,desc:s.desc,tags:s.tags,lang:s.lang})))}. The user is searching for: "${q}". Return ONLY a JSON array of snippet IDs that best match, ordered by relevance. Max 5.`}
      ],max_tokens:100,app_id:'kaixu-snippethub'})});
    const d=await r.json();
    const txt=(d.choices?.[0]?.message?.content||d.content||'[]').replace(/```json?/g,'').replace(/```/g,'').trim();
    const ids=JSON.parse(txt);
    if(ids.length){
      const el=document.getElementById('snipList');
      const aiMatches=ids.map(id=>snippets.find(s=>s.id===id)).filter(Boolean);
      if(aiMatches.length){
        toast(`kAIxU found ${aiMatches.length} matches`,'var(--cyan)');
        el.innerHTML='<div style="font-size:.7rem;color:var(--purple);padding:4px 8px;margin-bottom:4px">ü§ñ kAIxU results</div>'+aiMatches.map(s=>`
        <div class="snip-item${current&&current.id===s.id?' active':''}" onclick="selectSnippet('${s.id}')">
          <div class="snip-name">${s.name}</div>
          <div class="snip-meta"><span class="snip-lang">${s.lang}</span><span class="snip-scope">${s.scope}</span></div>
        </div>`).join('');
      }
    }
  }catch(e){/* silent */}
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
loadSnippets();
renderLangFilters();
renderList();
</script>
</body>
</html>
